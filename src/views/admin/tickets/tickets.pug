extends ../../layouts/layoutAdmin

block content
  .container.mt-4
    h2.text-center.mb-4 Quản lý Vé đặt

    // Form tìm kiếm nâng cao
    form(action="/admins/tickets/search" method="GET" class="row g-3 mb-4")
      .col-md-3
        label.form-label(for="customer_name") Tên người đặt
        input.form-control(type="text" name="customer_name" id="customer_name" value=(customer_name || ""))

      .col-md-3
        label.form-label(for="customer_phone") SĐT
        input.form-control(type="text" name="customer_phone" id="customer_phone" value=(customer_phone || ""))

      .col-md-3
        label.form-label(for="ticket_code") Mã vé
        input.form-control(type="text" name="ticket_code" id="ticket_code" value=(ticket_code || ""))

      .col-md-3
        label.form-label(for="status") Trạng thái
        select.form-select(name="status" id="status")
          option(value="") -- Chọn trạng thái --
          option(value="BOOKED" selected=(status === 'BOOKED' ? 'selected' : undefined)) Đã đặt
          option(value="CANCELED" selected=(status === 'CANCELED' ? 'selected' : undefined)) Đã hủy
          option(value="PENDING" selected=(status === 'PENDING' ? 'selected' : undefined)) Chờ xử lý
          option(value="USED" selected=(status === 'USED' ? 'selected' : undefined)) Đã sử dụng

      .col-md-3
        label.form-label(for="booking_time") Ngày đặt
        input.form-control(type="date" name="booking_time" id="booking_time" value=(booking_time || ""))

      .col-12.text-center
        button.btn.btn-primary(type="submit") Tìm kiếm
        a.btn.btn-secondary(href="/admins/tickets") Reset

    // Thông báo kết quả lọc (nếu có)
    if searchDescription
      .alert.alert-info.d-flex.justify-content-between.align-items-center(role="alert")
        span= searchDescription
        button.btn.btn-sm.btn-outline-danger(onclick="window.location.href='/admins/tickets'") X

    .table-responsive
      table.table.table-bordered.table-hover
        thead.table-dark
          tr
            th STT
            th Mã vé
            th Chuyến đi
            th Tên người đặt
            th SĐT
            th Giá vé
            th Tổng tiền
            th Trạng thái
            th Điểm đón
            th Điểm trả
            th Ngày đặt
            th Ngày cập nhật
            th Hành động
        tbody
          if tickets && tickets.length
            each ticket, index in tickets
              tr
                td= index + 1
                td= ticket.ticket_code
                td= ticket.trip_name || '-' 
                td= ticket.customer_name || '-'
                td= ticket.customer_phone || '-'
                td= ticket.ticket_price.toLocaleString('vi-VN') + ' đ'
                td= ticket.total_price_ticket ? ticket.total_price_ticket.toLocaleString('vi-VN') + ' đ' : '-'
                - var displayStatus = ticket.status === 'BOOKED' ? 'Đã đặt' : ticket.status === 'CANCELED' ? 'Đã hủy' : ticket.status === 'PENDING' ? 'Chờ xử lý' : ticket.status === 'USED' ? 'Đã sử dụng' : 'Không xác định'
                td= displayStatus
                td= ticket.pickup_location || '-'
                td= ticket.dropoff_location || '-'
                td= new Date(ticket.booking_time).toLocaleString('vi-VN')
                td= new Date(ticket.updated_at).toLocaleString('vi-VN')
                td
                  .d-flex.gap-2
                    a.btn.btn-warning.btn-sm(href=`/admins/tickets/update/${ticket.id}`) Sửa
                    form(action=`/admins/tickets/cancel/${ticket.id}`, method="POST", class="d-inline")
                      button.btn.btn-danger.btn-sm(type="submit" onclick="return confirm('Bạn có chắc muốn hủy vé này?')") Hủy
                    form(action=`/admins/tickets/remove/${ticket.id}`, method="POST", class="d-inline")
                      button.btn.btn-outline-danger.btn-sm(type="submit" onclick="return confirm('Bạn có chắc muốn xóa hoàn toàn vé này?')") Xóa
          else
            tr
              td.text-center(colspan="13") Không có vé nào được tìm thấy.

    .text-center.mt-4
      a.btn.btn-success(href="/admins/tickets/add") Thêm vé thủ công
